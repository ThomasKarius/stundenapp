<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wochenbericht / Stundenzettel</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0.5rem;
      background:#f5f5f5;
    }

    .wrapper {
      max-width: 700px;
      margin: 0 auto;
      background:#fff;
      border-radius: 12px;
      padding: 0.8rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    h1 {
      font-size: 1.1rem;
      margin: 0 0 0.5rem;
      text-align:center;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .field {
      flex: 1 1 110px;
      min-width: 100px;
      display:flex;
      flex-direction:column;
      font-size: 0.8rem;
    }

    .field label {
      margin-bottom: 0.15rem;
    }

    .field input {
      padding: 0.25rem 0.35rem;
      font-size: 0.85rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 0.25rem;
      text-align: center;
    }

    th {
      background:#fafafa;
      font-weight:600;
    }

    tbody tr:nth-child(odd) {
      background:#fcfcfc;
    }

    .totals {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      display:flex;
      justify-content: space-between;
      flex-wrap:wrap;
      gap:0.5rem;
    }

    .totals div {
      background:#fafafa;
      padding:0.4rem 0.6rem;
      border-radius:8px;
      border:1px solid #e0e0e0;
      flex:1 1 130px;
    }

    .signature-container {
      margin-top:0.8rem;
    }

    #signature-pad {
      width: 100%;
      height: 120px;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fff;
      touch-action:none;
    }

    .buttons {
      margin-top: 0.6rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      justify-content: space-between;
    }

    button {
      flex:1 1 140px;
      padding:0.5rem;
      border:none;
      border-radius:999px;
      font-size:0.85rem;
      cursor:pointer;
    }

    .btn-main {
      background:#007bff;
      color:#fff;
    }

    .btn-secondary {
      background:#e0e0e0;
    }

    .footer {
      margin-top:0.6rem;
      font-size:0.7rem;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:0.5rem;
    }

    .footer .field {
      min-width: 120px;
    }
  </style>
</head>
<body>
<div class="wrapper">
  <h1>Wochenbericht / Stundenzettel</h1>

  <div class="row">
    <div class="field">
      <label>Fahrer / Mitarbeiter</label>
      <input id="name" type="text" placeholder="Name" />
    </div>
    <div class="field">
      <label>vom</label>
      <input id="from" type="date" />
    </div>
    <div class="field">
      <label>bis</label>
      <input id="to" type="date" />
    </div>
    <div class="field">
      <label>KW</label>
      <input id="kw" type="number" min="1" max="53" />
    </div>
  </div>

  <div style="overflow-x:auto;">
    <table>
      <thead>
      <tr>
        <th>Tag</th>
        <th>Start</th>
        <th>Pause (Min)</th>
        <th>Ende</th>
        <th>Std. abzgl. Pause</th>
        <th>Tour (1, 2, ...)</th>
        <th>Spesen (€)</th>
      </tr>
      </thead>
      <tbody>
      <!-- Montag -->
      <tr id="row-mon" data-minutes="0">
        <td>Montag</td>
        <td><input id="start-mon" type="time" /></td>
        <td><input id="pause-mon" type="number" min="0" inputmode="numeric" /></td>
        <td><input id="end-mon" type="time" /></td>
        <td id="hours-mon"></td>
        <td><input id="tour-mon" type="text" /></td>
        <td><input id="spesen-mon" type="text" inputmode="decimal" /></td>
      </tr>
      <!-- Dienstag -->
      <tr id="row-die" data-minutes="0">
        <td>Dienstag</td>
        <td><input id="start-die" type="time" /></td>
        <td><input id="pause-die" type="number" min="0" inputmode="numeric" /></td>
        <td><input id="end-die" type="time" /></td>
        <td id="hours-die"></td>
        <td><input id="tour-die" type="text" /></td>
        <td><input id="spesen-die" type="text" inputmode="decimal" /></td>
      </tr>
      <!-- Mittwoch -->
      <tr id="row-mit" data-minutes="0">
        <td>Mittwoch</td>
        <td><input id="start-mit" type="time" /></td>
        <td><input id="pause-mit" type="number" min="0" inputmode="numeric" /></td>
        <td><input id="end-mit" type="time" /></td>
        <td id="hours-mit"></td>
        <td><input id="tour-mit" type="text" /></td>
        <td><input id="spesen-mit" type="text" inputmode="decimal" /></td>
      </tr>
      <!-- Donnerstag -->
      <tr id="row-don" data-minutes="0">
        <td>Donnerstag</td>
        <td><input id="start-don" type="time" /></td>
        <td><input id="pause-don" type="number" min="0" inputmode="numeric" /></td>
        <td><input id="end-don" type="time" /></td>
        <td id="hours-don"></td>
        <td><input id="tour-don" type="text" /></td>
        <td><input id="spesen-don" type="text" inputmode="decimal" /></td>
      </tr>
      <!-- Freitag -->
      <tr id="row-fre" data-minutes="0">
        <td>Freitag</td>
        <td><input id="start-fre" type="time" /></td>
        <td><input id="pause-fre" type="number" min="0" inputmode="numeric" /></td>
        <td><input id="end-fre" type="time" /></td>
        <td id="hours-fre"></td>
        <td><input id="tour-fre" type="text" /></td>
        <td><input id="spesen-fre" type="text" inputmode="decimal" /></td>
      </tr>
      <!-- Samstag -->
      <tr id="row-sam" data-minutes="0">
        <td>Samstag</td>
        <td><input id="start-sam" type="time" /></td>
        <td><input id="pause-sam" type="number" min="0" inputmode="numeric" /></td>
        <td><input id="end-sam" type="time" /></td>
        <td id="hours-sam"></td>
        <td><input id="tour-sam" type="text" /></td>
        <td><input id="spesen-sam" type="text" inputmode="decimal" /></td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="totals">
    <div>
      <strong>Gesamtstunden (Woche):</strong><br />
      <span id="total-hours">00:00</span>
    </div>
    <div>
      <strong>Spesen gesamt:</strong><br />
      <span id="total-spesen">0,00 €</span>
    </div>
  </div>

  <div class="signature-container">
    <label for="signature-pad" style="font-size:0.8rem;">Unterschrift:</label>
    <canvas id="signature-pad"></canvas>
  </div>

  <div class="buttons">
    <button class="btn-secondary" id="clear-signature">Unterschrift löschen</button>
    <button class="btn-main" id="share-whatsapp">Per WhatsApp teilen</button>
  </div>

  <div class="footer">
    <div class="field">
      <label>Datum</label>
      <input id="sign-date" type="date" />
    </div>
    <div class="field">
      <label>Ort</label>
      <input id="sign-place" type="text" />
    </div>
  </div>
</div>

<script>
  const days = [
    { id: "mon", label: "Montag" },
    { id: "die", label: "Dienstag" },
    { id: "mit", label: "Mittwoch" },
    { id: "don", label: "Donnerstag" },
    { id: "fre", label: "Freitag" },
    { id: "sam", label: "Samstag" }
  ];

  function parseTimeToMinutes(timeStr) {
    if (!timeStr) return null;
    const [h, m] = timeStr.split(":").map(Number);
    if (isNaN(h) || isNaN(m)) return null;
    return h * 60 + m;
  }

  function minutesToHHMM(min) {
    const hours = Math.floor(min / 60);
    const minutes = min % 60;
    return String(hours).padStart(2, "0") + ":" + String(minutes).padStart(2, "0");
  }

  function updateDay(dayId) {
    const start = parseTimeToMinutes(document.getElementById("start-" + dayId).value);
    const end = parseTimeToMinutes(document.getElementById("end-" + dayId).value);
    const pauseInput = document.getElementById("pause-" + dayId).value;
    const pause = parseInt(pauseInput || "0", 10);

    const hoursCell = document.getElementById("hours-" + dayId);
    const row = document.getElementById("row-" + dayId);

    if (start !== null && end !== null && !isNaN(pause)) {
      let diff = end - start - pause;
      if (diff < 0) diff = 0;
      hoursCell.textContent = minutesToHHMM(diff);
      row.dataset.minutes = diff;
    } else {
      hoursCell.textContent = "";
      row.dataset.minutes = 0;
    }
    updateTotals();
  }

  function updateTotals() {
    // Stunden
    let totalMinutes = 0;
    days.forEach(d => {
      const row = document.getElementById("row-" + d.id);
      totalMinutes += parseInt(row.dataset.minutes || "0", 10);
    });
    document.getElementById("total-hours").textContent = minutesToHHMM(totalMinutes);

    // Spesen
    let totalSpesen = 0;
    days.forEach(d => {
      const val = document.getElementById("spesen-" + d.id).value.trim();
      if (val) {
        const num = parseFloat(val.replace(",", "."));
        if (!isNaN(num)) totalSpesen += num;
      }
    });
    document.getElementById("total-spesen").textContent =
      totalSpesen.toFixed(2).replace(".", ",") + " €";
  }

  function buildWhatsappText() {
    const name = document.getElementById("name").value || "";
    const from = document.getElementById("from").value || "";
    const to = document.getElementById("to").value || "";
    const kw = document.getElementById("kw").value || "";
    const signDate = document.getElementById("sign-date").value || "";
    const signPlace = document.getElementById("sign-place").value || "";

    let lines = [];
    lines.push("Wochenbericht " + (name || "").trim());
    if (from || to) lines.push("Zeitraum: " + from + " - " + to);
    if (kw) lines.push("KW: " + kw);
    lines.push("");

    days.forEach(d => {
      const s = document.getElementById("start-" + d.id).value || "-";
      const e = document.getElementById("end-" + d.id).value || "-";
      const p = document.getElementById("pause-" + d.id).value || "0";
      const h = document.getElementById("hours-" + d.id).textContent || "00:00";
      const t = document.getElementById("tour-" + d.id).value || "-";
      const sp = document.getElementById("spesen-" + d.id).value || "0";
      if (s !== "-" || e !== "-" || t !== "-" || sp !== "0") {
        lines.push(
          d.label +
          ": Start " + s +
          ", Ende " + e +
          ", Pause " + p + " Min" +
          ", Std " + h +
          ", Tour " + t +
          ", Spesen " + sp + " €"
        );
      }
    });

    lines.push("");
    lines.push("Gesamtstunden: " + document.getElementById("total-hours").textContent);
    lines.push("Spesen gesamt: " + document.getElementById("total-spesen").textContent);
    if (signPlace || signDate) {
      lines.push("");
      lines.push("Ort/Datum: " + (signPlace || "") + " " + (signDate || ""));
    }
    lines.push("Unterschrift: __________");

    return lines.join("\n");
  }

  function sendWhatsapp() {
    const text = encodeURIComponent(buildWhatsappText());
    const url = "https://wa.me/?text=" + text;
    window.open(url, "_blank");
  }

  // Signature Pad
  const canvas = document.getElementById("signature-pad");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  function resizeCanvas() {
    const ratio = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;
    ctx.scale(ratio, ratio);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
  }

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    };
  }

  canvas.addEventListener("pointerdown", e => {
    drawing = true;
    ctx.beginPath();
    const pos = getPos(e);
    ctx.moveTo(pos.x, pos.y);
  });

  canvas.addEventListener("pointermove", e => {
    if (!drawing) return;
    const pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
  });

  canvas.addEventListener("pointerup", () => { drawing = false; });
  canvas.addEventListener("pointerleave", () => { drawing = false; });

  document.getElementById("clear-signature").addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  document.getElementById("share-whatsapp").addEventListener("click", sendWhatsapp);

  // Event-Listener für alle Eingaben
  days.forEach(d => {
    ["start", "end", "pause"].forEach(prefix => {
      document.getElementById(prefix + "-" + d.id)
        .addEventListener("input", () => updateDay(d.id));
    });
    document.getElementById("spesen-" + d.id)
      .addEventListener("input", updateTotals);
  });

  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();
</script>
</body>
</html>
